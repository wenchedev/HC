import{u as De,j as n,b as $e,Q as Ce,M as Oe,a as Be,c as Re,r as p,N as W,_ as pe,d as Fe,R as Ie,e as Le,f as ze,P as Ge,F as He,g as Ke,h as Qe,z as N,O as ve,i as qe,k as Ue,l as Je,I as Ve,m as We,n as Ze,B as P,C as Xe,T as et,J as tt,p as fe}from"./vendor-CRp11ELv.js";import{P as nt,H as at,F as rt,u as re,r as he,D as lt,G as st,E as ot,s as it,g as ct,n as dt,d as C,c as ye,a as ge,b as be,e as mt,f as ut,h as pt,A as ft,i as b,M as ht,j as yt,k as _e,l as gt,m as bt,o as _t}from"./components-C3ydSWCM.js";import{_ as we}from"./lodash-BqQwuHRF.js";import{h as xt}from"./moment-BLMuvzoS.js";import{a as le}from"./axios-C0Zqfgkc.js";function jt(){const u=De();return n.jsxs("div",{className:"flex flex-column px-4 py-4",id:"error-page",children:[n.jsx("h1",{children:"Oops!"}),n.jsx("p",{children:"Sorry, an unexpected error has occurred."}),n.jsx("p",{children:n.jsx("i",{children:u.statusText||u.message})})]})}window._=we;window.moment=xt;window.Buffer=$e.Buffer;const xe=u=>{var f,h;const m=(f=u.response)==null?void 0:f.data,_={style:{fontSize:"15px",whiteSpace:"nowrap !important",width:"auto"}};if(Array.isArray(m))we.map(m,S=>{if(S.field&&S.detail)return N.error(S.detail,_)});else if(m!=null&&m.detail)return N.error(m.detail,_);if(m){const S={style:{height:"100px",width:"300px",fontSize:"15px"}};if(Object.keys(m).length===0&&((h=u.response)!=null&&h.status))return N.error(`Oops something went wrong.
 Error occurred on the server. 
 Please try again later.`,S)}},vt=new Ce({queryCache:new Be({onError:xe}),mutationCache:new Oe({onError:xe,onSuccess:u=>{}})});function wt(){return n.jsx("div",{className:"flex flex-column gap-2 w-full h-full",children:n.jsx(ve,{})})}function Mt(){return n.jsx("div",{className:"flex w-full h-full",children:n.jsxs("div",{className:"flex flex-column w-full h-full",children:[n.jsx("div",{className:"flex flex-none w-full mb-5",children:n.jsx(at,{})}),n.jsx("div",{className:"flex flex-column flex-grow-1 justify-content-center pl-4 pr-4",children:n.jsx(ve,{})}),n.jsx("div",{className:"flex flex-none pt-5 w-full",children:n.jsx(rt,{})})]})})}const St=Re([{element:n.jsx(wt,{}),children:[{path:"",element:n.jsx(W,{replace:!0,to:"/login"})},{path:"/",element:n.jsx(W,{replace:!0,to:"/login"})},{path:"/login",Component:p.lazy(()=>pe(()=>Promise.resolve().then(()=>Nt),void 0))}]},{element:n.jsx(nt,{children:n.jsx(Mt,{})}),errorElement:n.jsx(jt,{}),children:[{path:"",element:n.jsx(W,{replace:!0,to:"/monthly-statement"})},{path:"/",element:n.jsx(W,{replace:!0,to:"/monthly-statement"})},{path:"/monthly-statement",Component:p.lazy(()=>pe(()=>Promise.resolve().then(()=>$t),void 0))}]}]);Fe.createRoot(document.getElementById("root")).render(n.jsx(Ie.StrictMode,{children:n.jsxs(Le,{client:vt,children:[n.jsx(ze,{initialIsOpen:!1}),n.jsx(p.Suspense,{fallback:n.jsx("div",{className:"flex h-full w-full justify-content-center align-items-center",children:n.jsx(Qe,{})}),children:n.jsxs(Ge,{children:[n.jsx(He,{position:"top-right",reverseOrder:!0,toastOptions:{className:"",duration:3e3,style:{height:"80px",width:"150px",fontSize:"18px"}}}),n.jsx(Ke,{router:St})]})})]})}));const Me=()=>le.create({baseURL:"https://homecareapis.azurewebsites.net",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),At=le.create({baseURL:"https://homecareapis.azurewebsites.net"}),Et=u=>le.create({baseURL:"https://www.googleapis.com/gmail/v1/",headers:{Authorization:`Bearer ${u}`}}),Yt=()=>qe({mutationFn:async u=>{try{const{data:m}=await At.post("/api/users/login",u);return localStorage.setItem("token",m.token),localStorage.setItem("email",m.email),localStorage.setItem("mobile",m.mobile),localStorage.setItem("address",m.address),localStorage.setItem("name",m.first_name+" "+m.last_name),m}catch(m){return m}}}),je=u=>Ue({queryKey:["MONTHLY_WORKSHEET",u,localStorage.getItem("email")],queryFn:async()=>{const m=Me(),{data:_}=await m.get(`rents/agent/${u}`);return _},staleTime:1500*1e3,gcTime:1800*1e3,refetchOnWindowFocus:!1,refetchOnMount:!1,refetchOnReconnect:!1}),kt=async(u,m,_)=>await Promise.all([_.get(`adminreport/${u}/${m}`),_.get(`/maintenances/property/${u}/${m}`),_.get(`/rents/property/${u}/${m}`)]),Tt=async(u,m,_)=>await Promise.all([_.get(`rents/property/year/report/${u}/${m}`),_.get(`maintenances/property/${u}`)]);function Pt(){const{setValue:u,resetState:m}=re(),[_,f]=p.useState(""),[h,S]=p.useState(""),[O,B]=p.useState(!1),[H,R]=p.useState(!1),$=Je(),{mutate:K,isError:Z}=Yt(),F=()=>{_&&h?(B(!1),K({email:_,password:h},{onSuccess:v=>{v!=null&&v.token?$("/monthly-statement"):R(!0)},onError:v=>{R(!0)}})):B(!0)};return n.jsxs("div",{className:"flex flex-column justify-content-center align-items-center gap-5 w-full h-full",children:[n.jsx(Ve,{alt:"home-care-logo",width:"241",src:"/HC/201512office_logo.png"}),n.jsxs("div",{className:"flex flex-column gap-3",children:[n.jsxs("div",{className:"flex-row p-inputgroup w-30rem login-input-group",children:[n.jsx("span",{className:"p-inputgroup-addon",children:n.jsx("i",{className:"pi pi-user"})}),n.jsx(We,{id:"username",value:_,onChange:v=>f(v.target.value),placeholder:"Email Address"})]}),n.jsxs("div",{className:"flex-row p-inputgroup w-30rem login-input-group",children:[n.jsx("span",{className:"p-inputgroup-addon",children:n.jsx("i",{className:"pi pi-key"})}),n.jsx(Ze,{icon:"pi pi-key",id:"password",value:h,onChange:v=>S(v.target.value),feedback:!1,placeholder:"Password",onKeyDown:v=>{(v==null?void 0:v.key)==="Enter"&&F()}})]})]}),n.jsxs("div",{className:"flex flex-column gap-3",children:[_&&h&&(H||Z)?n.jsx("div",{className:"flex justify-content-center text-base",style:{color:"red"},children:"Log in failed: username or password is incorrect"}):null,O?n.jsx("div",{className:"flex justify-content-center text-base",style:{color:"red"},children:"Username or password can not be empty!"}):null,n.jsx(P,{icon:"pi pi-arrow-circle-right",iconPos:"right",label:"Sign in",outlined:!0,className:"w-30rem",onClick:()=>{F()}})]})]})}const Nt=Object.freeze(Object.defineProperty({__proto__:null,default:Pt},Symbol.toStringTag,{value:"Module"}));function Dt(){const u={style:{fontSize:"15px",whiteSpace:"nowrap !important",width:"auto"}},{setValue:m,resetState:_}=re(),f=re(e=>e.selectedMonth),{data:h,isFetching:S}=je(moment(f).format("YYYY/M")),{data:O,isFetching:B}=je(moment(f).subtract(1,"month").format("YYYY/M")),H=["landlord_amount","tenant_amount","maintenance"],R=p.useMemo(()=>{const e=new Map;return B==!1&&O&&O.forEach(t=>{e.set(t.property,t)}),e},[O]),$=p.useMemo(()=>{if(h&&B==!1&&S==!1)return h.map(e=>{const t=R.get(e.property);if(!t)return{...e,_diff:"new"};const a=H.filter(l=>e[l]!=t[l]);return{...e,_diff:a.length>0?"changed":"same",...H.reduce((l,s)=>(l[`_prev_${s}`]=t[s],l),{})}})},[h,R]),K=Me(),[Z,F]=p.useState(!1),[v,se]=p.useState(!1),[oe,D]=p.useState([]),[A,Se]=p.useState("monthly"),[Ae,ie]=p.useState(!1),[Ee,Ye]=p.useState(null),[Q,X]=p.useState(null),[M,q]=p.useState(null),E=p.useRef(null),[Y,j]=p.useState({running:!1,done:0,total:0,label:""}),k=p.useRef({cancel:!1});p.useEffect(()=>{!S&&(h==null?void 0:h.length)>0&&m({type:"SET_MONTHLY_DATA",location:"monthlyWorksheet",value:h})},[h]),p.useEffect(()=>(D([]),D()),[A,f]),p.useEffect(()=>()=>{E.current&&clearTimeout(E.current),M&&he(M)},[M]);const ke=e=>new Promise(t=>setTimeout(t,e)),U=(e,t)=>{e&&D(a=>(a||[]).map(l=>l.id!==e?l:{...l,status:{...l.status||{},...t.state?{state:t.state}:{},...t.error!==void 0?{error:t.error}:{},...t.sentAt!==void 0?{sentAt:t.sentAt}:{}},email:{...l.email||{},...t.messageId!==void 0?{messageId:t.messageId}:{}}}))};async function ce({list:e,gmailToken:t,delayMs:a=1e3,onProgress:l,onItemStatus:s}){let r=0,d=0;for(let c=0;c<e.length;c++){const g=e[c];s==null||s(g.id,{state:"sending",error:null,sentAt:null});const w=ee(g);try{const o=await ye({to:g.to,subject:w.subject,htmlBody:w.html,pdfBlob:g.blob,filename:g.filename}),y=await fetch("https://gmail.googleapis.com/gmail/v1/users/me/messages/send",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({raw:o})});if(!y.ok){const i=await y.text();d++,s==null||s(g.id,{state:"failed",error:i});break}const x=await y.json();r++,N.success("Email has been sent to: "+g.to,u),s==null||s(g.id,{state:"sent",sentAt:Date.now(),messageId:x==null?void 0:x.id})}catch(o){d++,s==null||s(g.id,{state:"failed",error:String(o)}),N.error("Failed to send "+w.subject,u);break}l==null||l({index:c+1,total:e.length}),await ke(a)}return{sent:r,failed:d}}const I=p.useRef(new Map),J=({kind:e,propertyID:t,label:a})=>`${e}:${t}:${a||""}`,V=({kind:e,propertyID:t,built:a,label:l})=>{var w,o,y;if(!(a!=null&&a.blob)||!(a!=null&&a.filename))return;const s=((w=a.meta)==null?void 0:w.landlordEmail)||"",r=((o=a.meta)==null?void 0:o.landlordName)||"",d=((y=a.meta)==null?void 0:y.propertyAddress)||"",c=J({kind:e,propertyID:t,label:l}),g={blob:a.blob,filename:a.filename,to:s,landlordName:r,address:d,propertyID:t,kind:e,label:l,createdAt:Date.now()};return I.current.set(c,g),g},de=({kind:e,propertyID:t,label:a})=>{const l=J({kind:e,propertyID:t,label:a});return I.current.has(l)},Te=()=>Array.from(I.current.values()),me=async({rows:e,kind:t})=>{k.current.cancel=!1;const a=(e||[]).filter(o=>o==null?void 0:o.property),l=a.length;j({running:!0,done:0,total:l,label:`Preparing ${t} PDFs...`});const s=be(2),r=new tt;let d=0;const c=a.map(o=>s(async()=>{var x;if(k.current.cancel)return;const y=t==="monthly"?await ne(o.property):await te(o.property);!y||k.current.cancel||(r.file(y.filename,y.blob),V({kind:t,propertyID:o.property,built:y,label:(x=y.meta)==null?void 0:x.label}),d++,j(i=>({...i,done:d,label:`Built ${d}/${l}`})))}));if(await Promise.all(c),k.current.cancel){j({running:!1,done:0,total:0,label:""});return}j(o=>({...o,label:"Zipping..."}));const g=await r.generateAsync({type:"blob"}),w=t==="monthly"?moment(f).format("YYYY-MM"):moment(f).format("YYYY");C(g,`${t}-statements-${w}.zip`),j({running:!1,done:0,total:0,label:""})},ue=()=>{k.current.cancel=!0},ee=e=>{const t=ut({...e});return pt(t)},te=async e=>{var o,y,x;const t=moment(f).format("YYYY"),[{data:a},{data:l}]=await Tt(e,t,K),s=l.filter(i=>moment(i.maintenance_date).year()==moment(f).year());if(!(a!=null&&a.length))return null;const r=a.map(i=>ft({statement_date:moment.utc(i.rental_start).format("MMMM"),tenant_name:i.tenant,rent_start:moment.utc(i.rental_start).format("MMM DD"),rent_end:moment.utc(i.rental_end).format("MMM DD"),tenant_amount:b(i.tenant_amount),agent_amount:b(i.agent_amount+i.company_amount),cra_amount:b(i.cra),maintenance_amount:b(i.maintenance),landlord_amount:b(i.tenant_amount-i.agent_amount-i.company_amount-i.cra-i.maintenance)}));let d=null;(s==null?void 0:s.length)>0&&(d=s.map(i=>ht({date:moment(i.maintenance_date).format("MMM DD, YYYY"),item:i.item,amount:b(i.amount)})));const c=yt({title:`Landlord Property Yearly Statement - ${t}`,year:t,landlord_name:(o=a[0].property_docs)==null?void 0:o.landlord,landlord_address:a[0].prop_address,landlord_email:(y=a[0].property_docs)==null?void 0:y.email,property_address:a[0].prop_address,property_manager:a[0].agent_fullname,property_phone:(x=a[0].agent_docs)==null?void 0:x.mobile,monthly_record:r,maintenance_record:d??[]}),g=await fe(n.jsx(gt,{data:c})).toBlob(),w=`${_e(c.property.address).slice(0,120)} - ${t} Statement.pdf`;return{blob:g,filename:w,meta:{landlordEmail:c.landlord.email||"",landlordName:c.landlord.name||"",propertyAddress:c.property.address||"",label:t}}},ne=async e=>{var o,y,x;const t=moment(f).format("YYYY/M"),[{data:a},{data:l},{data:s}]=await kt(e,t,K),r=(a==null?void 0:a[0])??null,d=(s==null?void 0:s[0])??null,c={org:_t(),title:"Landlord Property Monthly Statement",landlord:{name:((o=r==null?void 0:r.property_docs)==null?void 0:o.landlord)??"",address:(r==null?void 0:r.prop_address)??"",email:((y=r==null?void 0:r.property_docs)==null?void 0:y.email)??""},property:{address:(r==null?void 0:r.prop_address)??"",manager:(r==null?void 0:r.agent_fullname)??"",phone:((x=r==null?void 0:r.agent_docs)==null?void 0:x.mobile)??"",transactionDate:r!=null&&r.rental_start?moment.utc(r.rental_start).format("MMMM YYYY"):""},earnings:{current:{tenantAmount:0,agentAmount:0,gstAgent:0,craAmount:0,maintenance:0,landlordTotal:0},ytd:{tenantAmount:0,agentAmount:0,gstAgent:0,craAmount:0,maintenance:0,landlordTotal:0}},maintenanceDetails:[]};if(r){const i=(r.agent_amount??0)+(r.company_amount??0),T=i/1.05,ae=i-T,L=r.tenant_amount??0,z=r.cra??0,G=r.maintenance??0;c.earnings.current={tenantAmount:b(L),agentAmount:b(T),gstAgent:b(ae),craAmount:b(z),maintenance:b(G),landlordTotal:b(L-i-z-G)}}if(d){const i=(d.agent_amount??0)+(d.company_amount??0),T=i/1.05,ae=i-T,L=d.tenant_amount??0,z=d.cra??0,G=d.maintenance??0;c.earnings.ytd={tenantAmount:b(L),agentAmount:b(T),gstAgent:b(ae),craAmount:b(z),maintenance:b(G),landlordTotal:b(L-i-z-G)}}Array.isArray(l)&&l.length>0&&(c.maintenanceDetails=l.map(i=>({item:i.item??"",date:i.maintenance_date?moment(i.maintenance_date).format("MMM DD, YYYY"):"",amountInclGst:b(i.amount??0)})));const g=await fe(n.jsx(bt,{data:c})).toBlob(),w=`${_e(c.property.address).slice(0,120)} - ${c.property.transactionDate}.pdf`;return{blob:g,filename:w,meta:{landlordEmail:c.landlord.email||"",landlordName:c.landlord.name||"",propertyAddress:c.property.address||"",label:moment(f).format("MMMM YYYY")}}},Pe=n.jsxs("div",{className:"flex py-3 gap-2 align-items-baseline",children:[n.jsx(P,{outlined:!0,icon:"pi pi-angle-left",onClick:()=>{m({type:"SET_SELECTED_MONTH",location:"selectedMonth",value:moment(f).subtract(1,"month").toDate()})}},"prev-month"),n.jsx(Xe,{value:f,onChange:e=>{m({type:"SET_SELECTED_MONTH",location:"selectedMonth",value:e.value})},showIcon:!0,view:"month",dateFormat:"yy-mm"},"month_picker"),n.jsx(P,{outlined:!0,icon:"pi pi-angle-right",onClick:()=>{m({type:"SET_SELECTED_MONTH",location:"selectedMonth",value:moment(f).add(1,"month").toDate()})}},"next-month"),n.jsx(P,{outlined:!0,label:Y.running?Y.label:"All Monthly PDFs",disabled:Y.running,onClick:()=>me({rows:h,kind:"monthly"}),className:"ml-6",icon:"pi pi-download"},"all-monthly"),n.jsx(P,{outlined:!0,label:Y.running?Y.label:"All Yearly PDFs",severity:"success",disabled:Y.running,onClick:()=>me({rows:h,kind:"yearly"}),className:"ml-3",icon:"pi pi-download"},"all-yearly"),Y.running&&n.jsx(P,{outlined:!0,severity:"danger",label:"Cancel",className:"ml-3",onClick:ue}),n.jsx(P,{outlined:!0,icon:"pi pi-file-export",label:"Create Bulk Email",severity:"warning",disabled:Y.running,onClick:()=>{se(!0)},className:"ml-3"},"bulk-email")]}),Ne=[{field:"report",header:"Download Statement",sortable:!1,filter:!1,className:"no-row-highlight",body:e=>n.jsxs("div",{className:"flex justify-content-center",children:[n.jsx(P,{outlined:!0,label:"Monthly",onClick:async()=>{const t="monthly",a=e.property,l=moment(f).format("YYYY/M"),s=J({kind:t,propertyID:a,label:l}),r=I.current.get(s);if(de({kind:t,propertyID:a,label:l})&&(r!=null&&r.blob))C(r.blob,r.filename);else{const d=await ne(e.property);if(!d)return;V({kind:t,propertyID:a,built:d,label:l}),C(d.blob,d.filename)}},disabled:!e.property},e.property+"month"),n.jsx(P,{outlined:!0,label:"Yearly",severity:"success",className:"ml-2",disabled:!e.property,onClick:async()=>{const t="yearly",a=e.property,l=moment(f).format("YYYY"),s=J({kind:t,propertyID:a,label:l}),r=I.current.get(s);if(de({kind:t,propertyID:a,label:l})&&(r!=null&&r.blob))C(r.blob,r.filename);else{const d=await te(e.property);if(!d)return;V({kind:t,propertyID:a,built:d,label:l}),C(d.blob,d.filename)}}},e.property+"year")]})},{field:"address_landlord",header:"Property [Landlord]: Address",body:e=>{var t;return`[${(t=e==null?void 0:e.property_docs)==null?void 0:t.landlord}]: ${e==null?void 0:e.prop_address}`}},{field:"rent_date",header:"Rent Date",formatter:"date"},{field:"landlord",header:"Landlord",body:e=>{var t;return`${(t=e==null?void 0:e.property_docs)==null?void 0:t.landlord}`}},{field:"agent_amount_due",header:"Due to Agent($)",body:e=>`${e==null?void 0:e.agent_amount}`},{field:"tenant",header:"Tenant"},{field:"tenant_amount",header:"Tenant($)"},{field:"landlord_amount",header:"Landord($)",body:e=>e._prev_landlord_amount!=e.landlord_amount?n.jsx("div",{className:"hover-inline","data-hover":`Last month: ${e._prev_landlord_amount}`,children:b(e.landlord_amount)}):b(e.landlord_amount)},{field:"agent_amount",header:"Agent($)"},{field:"maintenance",header:"Maintenance($)",body:e=>n.jsx("div",{className:e.maintenance>0?"row-maintenance-cell":"",children:e.maintenance})},{field:"company_amount",header:"Company($)"},{field:"cra",header:"CRA($)"},{field:"landlord_account",header:"Landlord Account",body:e=>{var t;return`${(t=e==null?void 0:e.property_docs)==null?void 0:t.account}`}},{field:"rental_start",header:"Rental Start",formatter:"date"},{field:"rental_end",header:"Rental End",formatter:"date"},{field:"note",header:"Note"}];return n.jsxs("div",{className:"flex flex-column w-full h-full align-items-start",children:[n.jsx("div",{className:"w-full text-5xl font-bold",children:"Rent Management"}),n.jsx(et,{target:".landlord-tooltip"}),n.jsx("div",{className:"w-full mt-5 gap-2 min-w-0",children:n.jsx(lt,{className:"w-full",value:($==null?void 0:$.length)>0?$:(h==null?void 0:h.length)>0?h:[],columns:Ne,injectHeader:Pe,overrides:{style:{width:"100%"},tableStyle:{width:"max-content"},scrollable:!0,loading:S,emptyMessage:"No records found.",rowClassName:(e=>{if(e._diff==="new")return{"row-new":!0};if(e._diff==="changed"){if(e._prev_landlord_amount<e.landlord_amount)return{"row-landlord-increase":!0};if(e._prev_landlord_amount>e.landlord_amount)return{"row-landlord-decrease":!0}}})}})}),n.jsx(st,{visible:Z,onHide:()=>{F(!1)},onToken:async e=>{if(e.access_token){q(e.access_token),E.current&&clearTimeout(E.current),E.current=setTimeout(()=>{q(null)},(e.expires_in-60)*1e3);const{data:t}=await Et(e.access_token).get("users/me/profile");X(t==null?void 0:t.emailAddress)}else console.log("missing access_token")}}),n.jsx(ot,{visible:v,onHide:()=>{se(!1),D([])},gmailToken:M,connectedGmail:Q,onOAuthClick:()=>{M?(E.current&&clearTimeout(E.current),he(M),q(null),X(null)):F(!0)},kind:A,onKindChange:Se,items:oe,bulk:Y,onCancelBulk:ue,onBuildAll:async()=>{k.current.cancel=!1;const e=A=="monthly"?moment(f).format("MMMM YYYY"):moment(f).format("YYYY"),t=Te().filter(o=>o.kind===A&&o.label==e),a=new Set(t.map(o=>o.propertyID)),l=t.map(o=>ge({...o,status:{state:"ready"},id:o.propertyID+"-"+o.label})),s=(h||[]).filter(o=>o==null?void 0:o.property),r=s.filter(o=>!a.has(o.property)),d=s.length;let c=l.length;j({running:!0,done:c,total:d,label:`Preparing ${A} PDFs...`}),D(l);const g=be(2),w=r.map(o=>g(async()=>{var i;if(k.current.cancel)return;const y=A==="monthly"?await ne(o.property):await te(o.property);if(!y||k.current.cancel)return;const x=V({kind:A,propertyID:o.property,built:y,label:(i=y.meta)==null?void 0:i.label});c++,D(T=>[...T,ge({...x,status:{state:"ready"},id:x.propertyID+"-"+x.label})]),j(T=>({...T,done:c,label:`Built ${c}/${d}`}))}));if(await Promise.all(w),k.current.cancel){j({running:!1,done:0,total:0,label:""});return}j({running:!1,done:0,total:0,label:""})},onSendAll:async e=>{if(!M){alert("Gmail not authenticated");return}const t=e!=null&&e.length?e:oe;j({running:!0,done:0,total:t.length,label:"Sending emails…"});const a=await ce({list:t,gmailToken:M,delayMs:1e3,onProgress:({index:l})=>j(s=>({...s,done:l})),onItemStatus:(l,s)=>U(l,s)});j({running:!1,label:`Done — ${a.sent} sent, ${a.failed} failed`})},onSendOne:async e=>{if(M){U(e.id,{state:"sending",error:null});try{await ce({list:[e],gmailToken:M,delayMs:0,onItemStatus:(t,a)=>U(t,a)})}catch(t){U(e.id,{state:"failed",error:String(t)})}}},onTestOne:async e=>{const t=ee(e),a=await ye({to:Q,subject:t.subject,htmlBody:t.html,pdfBlob:e.blob,filename:e.filename});return(await fetch("https://gmail.googleapis.com/gmail/v1/users/me/messages/send",{method:"POST",headers:{Authorization:`Bearer ${M}`,"Content-Type":"application/json"},body:JSON.stringify({raw:a})})).ok?N.success("Testing email has been sent to: "+Q,u):N.error("Failed to send "+t.subject,u)},onPreviewOne:async e=>{const t=ee(e);Ye({to:e.to,from:Q,subject:t.subject,htmlBody:t.html,pdfBlob:e.blob,filename:e.filename}),ie(!0)},onDownloadOne:e=>{C(e.blob,e.filename)},onCheckStatus:async e=>{var t;j({running:!0,label:"Checking emails…",type:"check"});try{const a=await it({gmailToken:M,emailAddresses:e.map(l=>l.to),subjectPrefix:A=="monthly"?moment(f).format("MMMM YYYY")+" Monthly Statement for":moment(f).format("YYYY")+" Annual Report",maxMessagesToScan:2e3,metadataConcurrency:4});j({running:!1,label:"",type:null}),D(l=>(l||[]).map(s=>{const r=ct({kind:A,label:s.label,address:s.address}),d=dt(r),c=a.bySubject[d];return!!c&&(c==null?void 0:c.to)==s.to?{...s,status:{...s.status||{},state:"sent",sentAt:c.latestSentDate},email:{...s.email||{}}}:s}))}catch(a){j({running:!1,label:"",type:null}),(t=a.message)!=null&&t.includes('"code": 401')?(E.current&&clearTimeout(E.current),q(null),X(null),N.error("Failed to connect the Gmail, please re-connect and try again",u)):N.error("Failed to check status, please try again later ",u)}}}),n.jsx(mt,{visible:Ae,onHide:()=>ie(!1),preview:Ee})]})}const $t=Object.freeze(Object.defineProperty({__proto__:null,default:Dt},Symbol.toStringTag,{value:"Module"}));
